(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{BiVN:function(e,t,n){},EsZP:function(e,t,n){},Hv6d:function(e,t,n){"use strict";var a=n("KPh1"),r=n("qRUh"),c=n("xwgP"),o=n.n(c),s=n("Wbzz"),l=n("d33t"),p=n.n(l),i=(n("vPK/"),n("Zttt")),b=n("EYWl"),u=n("JLKy"),m=n("k7Sn"),j=function(e){return m.supportedLanguages[e].replace(/ /g," ")},O=function(e){function t(){return e.apply(this,arguments)||this}return Object(r.a)(t,e),t.prototype.render=function(){var e=this.props,t=e.translations,n=e.lang,a=e.languageLink,r=e.editUrl;return o.a.createElement("div",{className:"translations"},o.a.createElement(u.a,{style:{fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",\n    "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans",\n    "Droid Sans", "Helvetica Neue", sans-serif'}},t.length>0&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",null,"Translated by readers into: "),t.map((function(e,r){return o.a.createElement(o.a.Fragment,{key:e},e===n?o.a.createElement("b",null,j(e)):o.a.createElement(s.Link,{to:a(e)},j(e)),r===t.length-1?"":" • ")}))),"zh-hans"!==n&&o.a.createElement(o.a.Fragment,null,o.a.createElement("br",null),o.a.createElement("br",null),o.a.createElement(s.Link,{to:a("zh-hans")},"Read the original")," • ",o.a.createElement("a",{href:r,target:"_blank",rel:"noopener noreferrer"},"Improve this translation")," • ",o.a.createElement(s.Link,{to:"/"+n},"View all translated posts")," ")))},t}(o.a.Component),d=n("L6NH"),g=n("p3AD");function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){Object(a.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var P=function(e){function t(){return e.apply(this,arguments)||this}return Object(r.a)(t,e),t.prototype.render=function(){console.log(this.props);var e=this.props,t=e.pageContext,a=e.children,r=e.location,c=e.previous,l=e.next,u=e.translations,m=p()(this.props,"queryData.site.siteMetadata.title"),h=t.langKey,P=t.slug;u&&(u=u.slice()).sort((function(e,t){return j(e)<j(t)?-1:1})),function(e){switch(e){case"ru":case"bg":n("EsZP"),n("s85H");break;case"uk":n("EsZP"),n("s85H"),n("Mq6Z"),n("e/YJ");break;case"cs":case"da":case"de":case"es":case"fi":case"fr":case"he":case"hu":case"it":case"nl":case"no":case"pl":case"pt-br":case"sk":case"sr":case"sq":case"sv":case"tr":n("Mq6Z"),n("e/YJ");break;case"vi":n("Vjog"),n("Pf5Y");break;case"fa":n("BiVN");break;case"ar":n("xpFW")}}(h);var x=function(e,t){var n=e.replace(t+"/","");return function(e){return"zh-hans"===e?n:""+e+n}}(P,h),y=x("en"),N="https://github.com/gaearon/overreacted.io/edit/master/src/pages/"+y.slice(1,y.length-1)+"/index"+("zh-hans"===h?"":"."+h)+".md";return o.a.createElement(i.a,{location:r,title:m},o.a.createElement(b.a,{lang:h,title:t.frontmatter.title,description:t.frontmatter.spoiler,slug:P,date:t.frontmatter.date}),o.a.createElement("div",{style:{marginLeft:"auto",marginRight:"auto",maxWidth:Object(g.a)(24)}},o.a.createElement("article",null,o.a.createElement("header",null,o.a.createElement("h1",{style:{color:"var(--textTitle)"}},t.frontmatter.title),o.a.createElement("p",{style:f(f({},Object(g.b)(-.2)),{},{display:"block",marginBottom:Object(g.a)(1),marginTop:Object(g.a)(-.8)})},Object(d.a)(t.frontmatter.date,h)),u&&u.length>0&&o.a.createElement(O,{translations:u,editUrl:N,languageLink:x,lang:h})),o.a.createElement("div",null,a)),o.a.createElement("aside",null,o.a.createElement("nav",null,o.a.createElement("ul",{style:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyle:"none",padding:0}},o.a.createElement("li",null,c&&o.a.createElement(s.Link,{to:c.fields.slug,rel:"prev",style:{marginRight:20}},"← ",c.frontmatter.title)),o.a.createElement("li",null,l&&o.a.createElement(s.Link,{to:l.fields.slug,rel:"next"},l.frontmatter.title," →")))))))},t}(o.a.Component);t.a=function(e){return o.a.createElement(s.StaticQuery,{query:"2199005656",render:function(t){return o.a.createElement(P,Object.assign({queryData:t},e))}})}},Mq6Z:function(e,t,n){},Pf5Y:function(e,t,n){},Vjog:function(e,t,n){},"e/YJ":function(e,t,n){},k7Sn:function(e,t){t.supportedLanguages={en:"English","zh-hans":"简体中文"}},ojTK:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return o})),n.d(t,"default",(function(){return p}));var a=n("shca"),r=(n("xwgP"),n("N0F1")),c=n("Hv6d"),o={},s={_frontmatter:o},l=c.a;function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)(l,Object.assign({},s,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",null,"前言"),Object(r.b)("p",null,"react-redux作为react和redux的粘合剂,可完成状态的订阅与更新。\n这部分涉及的核心功能点有三个:provider,context,connect。"),Object(r.b)("p",null,"面试高频:connect,mapStateToProps,mapDispatchToProps的应用和原理。"),Object(r.b)("p",null,"本篇为源码系列核心实现第四篇,对应下图react-redux部分。"),Object(r.b)("p",null,Object(r.b)("img",Object.assign({parentName:"p"},{src:"https://lengyuexin.github.io/gatsby/static/src-c54cf51e73a8fdc229c79ea7b981b607.png",alt:"src"}))),Object(r.b)("table",null,Object(r.b)("thead",{parentName:"table"},Object(r.b)("tr",{parentName:"thead"},Object(r.b)("th",Object.assign({parentName:"tr"},{align:null})),Object(r.b)("th",Object.assign({parentName:"tr"},{align:null})))),Object(r.b)("tbody",{parentName:"table"},Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"name"),Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"desc")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"provider"),Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"数据提供方")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"context"),Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"状态上下文对象")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"connect"),Object(r.b)("td",Object.assign({parentName:"tr"},{align:null}),"高阶组件,被包装后的组件可连接store")))),Object(r.b)("h2",null,"Provider与Context"),Object(r.b)("p",null,"Provider用于向所有组件传递数据仓库store,配合Context使用。"),Object(r.b)("h3",null,"基本使用"),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"//store来源于redux中createStore方法的返回值。\n function App() {\n  return (\n    <Provider store={store}>\n      <Child />\n    </Provider>\n  );\n}\n\n")),Object(r.b)("h3",null,"实现"),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"context的实现")),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"const context = React.createContext(null);\nexport default context;\n\n")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"provider的实现")),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"\n//ReactReduxContext就是上边的context\n class Provider extends Component{\n  render() {\n    return (\n      <ReactReduxContext.Provider\n        value={{store: this.props.store}}\n      >\n        {this.props.children}\n      </ReactReduxContext.Provider>\n    );\n  }\n}\n\n")),Object(r.b)("p",null,"这就完事了？是的,大道至简。\n关键也不在这里,下面来看重头戏connect。"),Object(r.b)("h2",null,"connect"),Object(r.b)("h3",null,"connect是怎么使用的？"),Object(r.b)("p",null,"了解其背后实现前,先看一下大概用法。"),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"import { connect } from 'react-redux'\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(App)\n\n")),Object(r.b)("p",null,"就这？对,就这一下子就完事了。\nconnect是高阶函数,最后会返回一个包装后的组件。"),Object(r.b)("h3",null,"mapStateToProps和mapDispatchToProps"),Object(r.b)("p",null,"connect方法可接受两个参数:mapStateToProps和mapDispatchToProps。\n其中mapStateToProps用于将从store中获取的state映射到被包裹组件的props上,主要用于数据渲染。\nmapDispatchToProps是将交互逻辑映射成action后传递给被包装后的组件,主要用于事件交互(如点击)。"),Object(r.b)("p",null,"mapStateToProps是一个函数,最后会返回一个对象,对象属性为store中状态树的同名属性。"),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"//store中数据\nstate:{\n    name:'冷月心'\n}\nconst mapStateToProps = (state) => {\n  return {\n    name:state.name\n  }\n}\n\n//被connect包裹后组件props中可以拿到name属性\nfunction App(props){\n props.name//冷月心\n}\n\n")),Object(r.b)("p",null,"mapStateToProps会订阅 Store,state更新会触发视图的重新渲染,这在react中表现为setState。\n这部分就涉及到了subscribe和setState,暂且略过,下文会提到。"),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"第二个参数")),Object(r.b)("p",null,"我之前面试,忘了哪个面家面试官问的了,但确实没回答上。"),Object(r.b)("p",null,"他问我mapStateToProps和mapDispatchToProps的第二个参数是什么？\n说实话我脑瓜子嗡嗡的,当时一脸诧异,这还有第二个参数？\n后来了解到确实有,就是组件自身的props,也可以叫ownProps。\n且ownProps发生改变,mapStateToProps和mapDispatchToProps就会重新被调用。"),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"不同类型的mapDispatchToProps")),Object(r.b)("p",null,"与mapStateToProps不同,mapDispatchToProps可以是一个对象,也可以是一个函数。\nconnect内部,对象类型的mapDispatchToProps会使用bindActionCreators完成ActionCreators与dispatch的绑定。\n函数类型的mapDispatchToProps会接收一个dispatch参数,返回dispatch后的action。"),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),"//函数形式\nconst mapDispatchToProps = (\n  dispatch\n) => {\n  return {\n    onClick: () => {\n      dispatch({\n        type: 'ADD',\n      });\n    }\n  };\n}\n\n//对象形式\n\nconst mapDispatchToProps = {\n  onClick: () => ({\n    type: 'ADD',\n  })\n}\n\n\n")),Object(r.b)("p",null,"具体使用哪种形式还是看个人习惯，喜欢就好。"),Object(r.b)("h3",null,"connect的实现"),Object(r.b)("p",null," connect一共做了四件事:订阅,状态映射,dispatch映射,返回扩展后的被包裹组件。"),Object(r.b)("pre",null,Object(r.b)("code",Object.assign({parentName:"pre"},{className:"language-js"}),'\nimport React from "react";\nimport bindActionCreators from "../redux/bindActionCreators";\nimport ReactReduxContext from "./Context";\nexport default function (mapStateToProps, mapDispatchToProps) {\n  return function (OldComponent) {\n    return class newComponent extends React.Component {\n      unsubscribe;\n      static contextType = ReactReduxContext;\n      constructor(props, context) {\n        super(props);\n        this.state = mapStateToProps(context.store.getState());\n      }\n\n      componentDidMount() {\n        this.unsubscribe = this.context.store.subscribe(() => {\n          // mapStateToProps接收一个state参数,返回一个state对象\n          this.setState(mapStateToProps(this.context.store.getState()));\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        let actions;\n        if (typeof mapDispatchToProps === "function") {\n          actions = mapDispatchToProps(this.context.store.dispatch);\n        } else if (\n          mapDispatchToProps &&\n          typeof mapDispatchToProps === "object"\n        ) {\n          actions = bindActionCreators(\n            mapDispatchToProps,\n            this.context.store.dispatch\n          );\n        }\n\n        return <OldComponent {...this.state} {...actions} />;\n      }\n    };\n  };\n}\n\n\n')),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"connect在挂载阶段订阅更新函数setState,在卸载阶段取消订阅。"),Object(r.b)("li",{parentName:"ul"},"connect从context的store中调用getState,返回值作为参数给mapStateToProps。"),Object(r.b)("li",{parentName:"ul"},"mapStateToProps函数执行的返回值用于初始化this.state,之后传递给被包裹组件。"),Object(r.b)("li",{parentName:"ul"},"对于dispatch映射分为两种情况,如果mapDispatchToProps是一个对象,就需要用bingActionCreators绑定"),Object(r.b)("li",{parentName:"ul"},"如果mapDispatchToProps是一个函数,就给这个函数传递dispatch参数并调用,最后返回的actions传递给被包裹的组件。"),Object(r.b)("li",{parentName:"ul"},"最终,将映射完的组件返回。")),Object(r.b)("h2",null,"源码压缩包"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object.assign({parentName:"li"},{href:"https://github.com/lengyuexin/code"}),"https://github.com/lengyuexin/code"))),Object(r.b)("h2",null,"再会"),Object(r.b)("p",null,"情如风雪无常,"),Object(r.b)("p",null,"却是一动既殇。"),Object(r.b)("p",null,"感谢你这么好看还来阅读我的文章,"),Object(r.b)("p",null,"我是冷月心,下期再见。"))}p.isMDXComponent=!0},s85H:function(e,t,n){},shca:function(e,t,n){"use strict";function a(e,t){if(null==e)return{};var n,a,r={},c=Object.keys(e);for(a=0;a<c.length;a++)n=c[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}n.d(t,"a",(function(){return a}))},"vPK/":function(e,t,n){},xpFW:function(e,t,n){}}]);
//# sourceMappingURL=component---src-pages-react-redux-index-mdx-4b570b680f14fd944542.js.map